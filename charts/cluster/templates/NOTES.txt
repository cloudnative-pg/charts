{{ if .Release.IsInstall }}
The {{ include "cluster.color-info" (include "cluster.fullname" .) }} has been installed successfully.
{{ else if .Release.IsUpgrade }}
The {{ include "cluster.color-info" (include "cluster.fullname" .) }} has been upgraded successfully.
{{ end }}

   ██████   ██                       ██ ████     ██             ██   ██                  ███████    ████████
  ██░░░░██ ░██                      ░██░██░██   ░██            ░██  ░░                  ░██░░░░██  ██░░░░░░██
 ██    ░░  ░██  ██████  ██   ██     ░██░██░░██  ░██  ██████   ██████ ██ ██    ██  █████ ░██   ░██ ██      ░░
░██        ░██ ██░░░░██░██  ░██  ██████░██ ░░██ ░██ ░░░░░░██ ░░░██░ ░██░██   ░██ ██░░░██░███████ ░██
░██        ░██░██   ░██░██  ░██ ██░░░██░██  ░░██░██  ███████   ░██  ░██░░██ ░██ ░███████░██░░░░  ░██    █████
░░██    ██ ░██░██   ░██░██  ░██░██  ░██░██   ░░████ ██░░░░██   ░██  ░██ ░░████  ░██░░░░ ░██      ░░██  ░░░░██
 ░░██████  ███░░██████ ░░██████░░██████░██    ░░███░░████████  ░░██ ░██  ░░██   ░░██████░██       ░░████████
  ░░░░░░  ░░░  ░░░░░░   ░░░░░░  ░░░░░░ ░░      ░░░  ░░░░░░░░    ░░  ░░    ░░     ░░░░░░ ░░         ░░░░░░░░

Cheatsheet
----------

Run Helm Tests:
{{ include "cluster.color-info" (printf "helm test --namespace %s %s" .Release.Namespace .Release.Name) }}

Get a list of all base backups:
{{ include "cluster.color-info" (printf "kubectl --namespace %s get backups --selector cnpg.io/cluster=%s" .Release.Namespace (include "cluster.fullname" .)) }}

Connect to the cluster's primary instance:
{{ include "cluster.color-info" (printf "kubectl --namespace %s exec --stdin --tty services/%s-rw -- bash" .Release.Namespace (include "cluster.fullname" .)) }}

Configuration
-------------

{{- $redundancyColor := "" -}}
{{- if lt (int .Values.cluster.instances) 2 }}
  {{- $redundancyColor = "error" -}}
{{- else if lt (int .Values.cluster.instances) 3 -}}
  {{- $redundancyColor = "warning" -}}
{{- else -}}
  {{- $redundancyColor = "ok" -}}
{{- end }}

{{ $scheduledBackups := (first .Values.backups.scheduledBackups).name }}
{{- range (rest .Values.backups.scheduledBackups) -}}
  {{ $scheduledBackups = printf "%s, %s" $scheduledBackups .name }}
{{- end -}}
{{- if eq (len .Values.backups.scheduledBackups) 0 }}
  {{- $scheduledBackups = "None" -}}
{{- end -}}

{{- $source := "" -}}
{{- if (eq (include "cluster.recovery.method.pgBasebackup.enabled" .) "true") }}
  {{- $source = printf "postgresql://%s@%s:%.0f/%s" .Values.recovery.methodSettings.pgBasebackup.connectionParameters.username .Values.recovery.methodSettings.pgBasebackup.connectionParameters.host .Values.recovery.methodSettings.pgBasebackup.connectionParameters.port .Values.recovery.methodSettings.pgBasebackup.connectionParameters.database -}}
{{- end -}}

╭───────────────────┬──────────────────────────────────────────────────────────╮
│ Configuration     │ Value                                                    │
┝━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
│ Cluster mode      │ {{ (printf "%-56s" .Values.mode) }} │
│ Type              │ {{ (printf "%-56s" .Values.type) }} │
│ Image             │ {{ include "cluster.color-info" (printf "%-56s" (include "cluster.imageName" .)) }} │
{{- if (eq (include "cluster.recovery.method.pgBasebackup.enabled" .) "true") }}
│ Source            │ {{ printf "%-56s" $source }} │
{{- end }}
│ Instances         │ {{ include (printf "%s%s" "cluster.color-" $redundancyColor) (printf "%-54s" (toString .Values.cluster.instances)) }} │
│ Backups           │ {{ include (printf "%s%s" "cluster.color-" (ternary "ok" "error" (eq (include "cluster.backups.enabled" .) "true"))) (printf "%-54s" (ternary "Enabled" "Disabled" (eq (include "cluster.backups.enabled" .) "true"))) }} │
│ Backup Provider   │ {{ (printf "%-56s" (title .Values.backups.objectStorage.provider)) }} │
│ Scheduled Backups │ {{ (printf "%-56s" $scheduledBackups) }} │
│ Storage           │ {{ (printf "%-56s" .Values.cluster.storage.size) }} │
│ Storage Class     │ {{ (printf "%-56s" (default "Default" .Values.cluster.storage.storageClass)) }} │
│ PGBouncer         │ {{ (printf "%-56s" (ternary "Enabled" "Disabled" .Values.pooler.enabled)) }} │
│ Monitoring        │ {{ include (printf "%s%s" "cluster.color-" (ternary "ok" "error" .Values.cluster.monitoring.enabled)) (printf "%-54s" (ternary "Enabled" "Disabled" .Values.cluster.monitoring.enabled)) }} │
╰───────────────────┴────────────────────────────────────────────────────────╯

{{ if ne (include "cluster.backups.enabled" .) "true" }}
  {{- include "cluster.color-error" "Warning! Backups not enabled. Recovery will not be possible! Do not use this configuration in production.\n" }}
{{ end -}}

{{ if lt (int .Values.cluster.instances) 2 }}
  {{- include "cluster.color-error" "Warning! Instance failure will lead to downtime and/or data loss!\n" }}
{{- else if lt (int .Values.cluster.instances) 3 -}}
  {{- include "cluster.color-warning" "Warning! Single instance redundancy available only. Instance failure will put the cluster at risk.\n" }}
{{ end -}}

{{ if or (and (eq (include "cluster.recovery.enabled" .) "true") (not (empty .Values.recovery.existingSecret))) (and (eq (include "cluster.backups.enabled" .) "true") (not (empty .Values.backups.existingSecret))) }}
  {{- include "cluster.color-info" "Existing secrets are used, make sure they have been created with all the necessary keys\n" }}
{{ end -}}
