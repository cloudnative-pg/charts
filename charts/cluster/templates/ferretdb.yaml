{{ if and (eq .Values.type "documentdb") .Values.ferretdb.enabled }}
{{- $dbOwner := .Values.cluster.initdb.owner | default .Values.cluster.initdb.database | default "app" }}
{{- $dbName := .Values.cluster.initdb.database | default "app" }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "cluster.fullname" . }}-ferretdb
  namespace: {{ include "cluster.namespace" . }}
  labels:
    {{- include "cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: ferretdb
spec:
  replicas: {{ .Values.ferretdb.instances }}
  selector:
    matchLabels:
      {{- include "cluster.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: ferretdb
  template:
    metadata:
      labels:
        {{- include "cluster.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: ferretdb
    spec:
      containers:
      - name: ferretdb
        image: {{ .Values.ferretdb.image | default "ghcr.io/ferretdb/ferretdb" }}:{{ .Values.ferretdb.tag | default .Values.version.ferretdb }}
        imagePullPolicy: {{ .Values.cluster.imagePullPolicy }}
        ports:
        - name: mongodb
          containerPort: 27017
          protocol: TCP
        command: ["/bin/sh"]
        args:
        - "-c"
        - |
          {{- $credMethod := .Values.ferretdb.credentialMethod | default "pgpass" }}
          {{- if eq $credMethod "pgpass" }}
          # Create .pgpass file for secure password handling
          echo "{{ include "cluster.fullname" . }}-rw:5432:{{ $dbName }}:{{ $dbOwner }}:${DB_PASSWORD}" > /tmp/.pgpass
          chmod 600 /tmp/.pgpass
          export PGPASSFILE=/tmp/.pgpass
          PG_URL="postgres://{{ $dbOwner }}@{{ include "cluster.fullname" . }}-rw:5432/{{ $dbName }}{{- if .Values.ferretdb.sslMode }}?sslmode={{ .Values.ferretdb.sslMode }}{{- end }}"
          {{- else if eq $credMethod "password-in-url" }}
          # Using password in URL (less secure, for dev/test only)
          PG_URL="postgres://{{ $dbOwner }}:${DB_PASSWORD}@{{ include "cluster.fullname" . }}-rw:5432/{{ $dbName }}{{- if .Values.ferretdb.sslMode }}?sslmode={{ .Values.ferretdb.sslMode }}{{- end }}"
          {{- else if eq $credMethod "env" }}
          # Using PGPASSWORD environment variable
          export PGPASSWORD="${DB_PASSWORD}"
          PG_URL="postgres://{{ $dbOwner }}@{{ include "cluster.fullname" . }}-rw:5432/{{ $dbName }}{{- if .Values.ferretdb.sslMode }}?sslmode={{ .Values.ferretdb.sslMode }}{{- end }}"
          {{- end }}

          exec /ferretdb \
            --listen-addr=:27017 \
            --postgresql-url="${PG_URL}" \
            --telemetry={{ .Values.ferretdb.telemetry | default "disable" }} \
            --log-level={{ .Values.ferretdb.logLevel | default "info" }} \
            {{- if .Values.ferretdb.auth }}
            --auth={{ .Values.ferretdb.auth }} \
            {{- end }}
            {{- if .Values.ferretdb.mode }}
            --mode={{ .Values.ferretdb.mode }} \
            {{- end }}
            {{- if .Values.ferretdb.debugAddr }}
            --debug-addr={{ .Values.ferretdb.debugAddr }} \
            {{- end }}
            {{- if .Values.ferretdb.otelTracesUrl }}
            --otel-traces-url={{ .Values.ferretdb.otelTracesUrl }} \
            {{- end }}
            {{- range .Values.ferretdb.extraArgs }}
            {{ . }} \
            {{- end }}
        env:
        {{- if .Values.cluster.initdb.secret }}
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.cluster.initdb.secret.name }}
              key: password
        {{- else }}
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "cluster.fullname" . }}-app
              key: password
        {{- end }}
        {{- with .Values.ferretdb.env }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with .Values.ferretdb.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        livenessProbe:
          tcpSocket:
            port: 27017
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 27017
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "cluster.fullname" . }}-ferretdb
  namespace: {{ include "cluster.namespace" . }}
  labels:
    {{- include "cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: ferretdb
spec:
  type: ClusterIP
  ports:
  - name: mongodb
    port: 27017
    targetPort: 27017
    protocol: TCP
  selector:
    {{- include "cluster.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: ferretdb
{{- end }}
