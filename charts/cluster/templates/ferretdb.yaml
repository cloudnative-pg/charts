{{ if and (eq .Values.type "documentdb") .Values.ferretdb.enabled }}
{{- $dbOwner := .Values.cluster.initdb.owner | default .Values.cluster.initdb.database | default "app" }}
{{- $dbName := .Values.cluster.initdb.database | default "app" }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "cluster.fullname" . }}-ferretdb
  namespace: {{ include "cluster.namespace" . }}
  labels:
    {{- include "cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: ferretdb
spec:
  replicas: {{ .Values.ferretdb.instances }}
  selector:
    matchLabels:
      {{- include "cluster.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: ferretdb
  template:
    metadata:
      labels:
        {{- include "cluster.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: ferretdb
    spec:
      # Init container to build PostgreSQL connection URL with password
      initContainers:
      - name: setup-pgurl
        image: busybox:1.36
        # Run as same user as FerretDB container to ensure file permissions work
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
        command: ["/bin/sh", "-c"]
        args:
        - |
          # Read password from secret and build connection URL
          PASSWORD=$(cat /secrets/password)
          cat > /pgurl/pgurl <<EOF
          postgres://{{ $dbOwner }}:${PASSWORD}@{{ include "cluster.fullname" . }}-rw:5432/{{ $dbName }}{{- if .Values.ferretdb.sslMode }}?sslmode={{ .Values.ferretdb.sslMode }}{{- end }}
          EOF
          chmod 600 /pgurl/pgurl
        volumeMounts:
        - name: pgurl
          mountPath: /pgurl
        - name: db-password
          mountPath: /secrets
          readOnly: true
      containers:
      - name: ferretdb
        image: {{ .Values.ferretdb.image | default "ghcr.io/ferretdb/ferretdb" }}:{{ .Values.ferretdb.tag | default .Values.version.ferretdb }}
        imagePullPolicy: {{ .Values.cluster.imagePullPolicy }}
        ports:
        - name: mongodb
          containerPort: 27017
          protocol: TCP
        # Use FerretDB's native file-based credential support (no shell required)
        args:
        - --listen-addr=:27017
        - --postgresql-url-file=/pgurl/pgurl
        - --telemetry={{ .Values.ferretdb.telemetry | default "disable" }}
        - --log-level={{ .Values.ferretdb.logLevel | default "info" }}
        {{- if .Values.ferretdb.auth }}
        - --auth={{ .Values.ferretdb.auth }}
        {{- end }}
        {{- if .Values.ferretdb.mode }}
        - --mode={{ .Values.ferretdb.mode }}
        {{- end }}
        {{- if .Values.ferretdb.debugAddr }}
        - --debug-addr={{ .Values.ferretdb.debugAddr }}
        {{- end }}
        {{- if .Values.ferretdb.otelTracesUrl }}
        - --otel-traces-url={{ .Values.ferretdb.otelTracesUrl }}
        {{- end }}
        {{- range .Values.ferretdb.extraArgs }}
        - {{ . }}
        {{- end }}
        volumeMounts:
        - name: pgurl
          mountPath: /pgurl
          readOnly: true
        {{- with .Values.ferretdb.env }}
        env:
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with .Values.ferretdb.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        livenessProbe:
          tcpSocket:
            port: 27017
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 27017
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: pgurl
        emptyDir:
          medium: Memory  # Use in-memory storage for credentials
      - name: db-password
        secret:
          {{- if .Values.cluster.initdb.secret }}
          secretName: {{ .Values.cluster.initdb.secret.name }}
          {{- else }}
          secretName: {{ include "cluster.fullname" . }}-app
          {{- end }}
          items:
          - key: password
            path: password
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "cluster.fullname" . }}-ferretdb
  namespace: {{ include "cluster.namespace" . }}
  labels:
    {{- include "cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: ferretdb
spec:
  type: ClusterIP
  ports:
  - name: mongodb
    port: 27017
    targetPort: 27017
    protocol: TCP
  selector:
    {{- include "cluster.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: ferretdb
{{- end }}
